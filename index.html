<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Media Automation - AI Content Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 600px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab-btn.active {
            color: #007bff;
            background: white;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #007bff;
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .platform-card {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .platform-card:hover {
            border-color: #007bff;
            box-shadow: 0 5px 15px rgba(0,123,255,0.1);
        }

        .platform-card.connected {
            border-color: #28a745;
            background: #f8fff9;
        }

        .platform-card i {
            font-size: 3rem;
            margin-bottom: 10px;
            color: #6c757d;
        }

        .platform-card.connected i {
            color: #28a745;
        }

        .platform-card h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .platform-card p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .disconnect-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .platform-card.connected:hover .disconnect-btn {
            display: flex;
        }

        .disconnect-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .posts-list {
            margin-top: 20px;
        }

        .post-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .post-item h4 {
            margin-bottom: 5px;
        }

        .post-item p {
            color: #6c757d;
            margin-bottom: 5px;
        }

        .post-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .schedule-options {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .schedule-toggle {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .schedule-toggle label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: normal;
        }

        .schedule-datetime {
            display: none;
        }

        .schedule-datetime.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> AI Social Media Automation</h1>
            <p>Generate and schedule AI-powered content across all your social platforms</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('auth')">Login/Register</button>
                <button class="tab-btn" onclick="showTab('platforms')" id="platforms-tab" disabled>Connect Platforms</button>
                <button class="tab-btn" onclick="showTab('create')" id="create-tab" disabled>Create Post</button>
                <button class="tab-btn" onclick="showTab('posts')" id="posts-tab" disabled>My Posts</button>
            </div>

            <!-- Authentication Tab -->
            <div id="auth" class="tab-content active">
                <h2 style="margin-bottom: 20px; color: #495057;"><i class="fas fa-user-circle"></i> Welcome</h2>

                <div id="auth-message" class="hidden"></div>

                <div id="login-form">
                    <h3>Login to Your Account</h3>
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" placeholder="Your password" required>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="login()">Login</button>
                        <button class="btn btn-secondary" onclick="showRegister()">Need Account?</button>
                    </div>
                </div>

                <div id="register-form" class="hidden">
                    <h3>Create New Account</h3>
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="register-name">Full Name</label>
                        <input type="text" id="register-name" placeholder="Your Full Name" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password</label>
                        <input type="password" id="register-password" placeholder="Choose a password" required>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="register()">Register</button>
                        <button class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
                    </div>
                </div>
            </div>

            <!-- Platforms Tab -->
            <div id="platforms" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #495057;"><i class="fas fa-plug"></i> Connect Your Platforms</h2>

                <div id="platforms-message" class="hidden"></div>

                <p style="margin-bottom: 20px; color: #6c757d;">
                    Connect your social media accounts to start posting. We'll securely store your credentials.
                </p>

                <div class="platform-grid">
                    <div class="platform-card" onclick="setupPlatform('instagram')" id="instagram-card">
                        <button class="disconnect-btn" onclick="disconnectPlatform('instagram', event)" title="Disconnect Instagram">
                            <i class="fas fa-times"></i>
                        </button>
                        <i class="fab fa-instagram"></i>
                        <h3>Instagram</h3>
                        <p>Share photos and videos with your followers</p>
                        <div class="status-badge status-disconnected" id="instagram-status">Not Connected</div>
                    </div>

                    <div class="platform-card" onclick="setupPlatform('facebook')" id="facebook-card">
                        <button class="disconnect-btn" onclick="disconnectPlatform('facebook', event)" title="Disconnect Facebook">
                            <i class="fas fa-times"></i>
                        </button>
                        <i class="fab fa-facebook"></i>
                        <h3>Facebook</h3>
                        <p>Post to your Facebook page or profile</p>
                        <div class="status-badge status-disconnected" id="facebook-status">Not Connected</div>
                    </div>

                    <div class="platform-card" onclick="setupPlatform('youtube')" id="youtube-card">
                        <button class="disconnect-btn" onclick="disconnectPlatform('youtube', event)" title="Disconnect YouTube">
                            <i class="fas fa-times"></i>
                        </button>
                        <i class="fab fa-youtube"></i>
                        <h3>YouTube</h3>
                        <p>Upload videos to your channel</p>
                        <div class="status-badge status-disconnected" id="youtube-status">Not Connected</div>
                    </div>

                    <div class="platform-card" onclick="setupPlatform('linkedin')" id="linkedin-card">
                        <button class="disconnect-btn" onclick="disconnectPlatform('linkedin', event)" title="Disconnect LinkedIn">
                            <i class="fas fa-times"></i>
                        </button>
                        <i class="fab fa-linkedin"></i>
                        <h3>LinkedIn</h3>
                        <p>Share professional content</p>
                        <div class="status-badge status-disconnected" id="linkedin-status">Not Connected</div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="checkPlatformStatus()" style="margin-top: 20px;">
                    <i class="fas fa-sync"></i> Refresh Status
                </button>

                <button class="btn btn-secondary" onclick="testToken()" style="margin-top: 10px;">
                    <i class="fas fa-key"></i> Test Authentication
                </button>

                <button class="btn btn-secondary" onclick="debugToken()" style="margin-top: 10px;">
                    <i class="fas fa-bug"></i> Debug Token
                </button>
            </div>

            <!-- Create Post Tab -->
            <div id="create" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #495057;"><i class="fas fa-plus-circle"></i> Create New Post</h2>

                <div id="create-message" class="hidden"></div>

                <form id="create-post-form" onsubmit="return false;">
                    <div class="form-group">
                        <label for="content-type">Content Type</label>
                        <select id="content-type" required>
                            <option value="IMAGE">Image</option>
                            <option value="VIDEO">Video</option>
                            <option value="PPT">Presentation</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="prompt">AI Prompt</label>
                        <textarea id="prompt" placeholder="Describe what you want the AI to create...
Examples:
- A beautiful sunset over mountains with vibrant colors
- An animated rocket launching into space
- Create a presentation about renewable energy solutions" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="caption">Caption (Optional)</label>
                        <textarea id="caption" placeholder="Add a custom caption for your post..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Select Platforms</label>
                        <div id="platform-checkboxes">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="schedule-options">
                        <h4><i class="fas fa-clock"></i> Posting Schedule</h4>

                        <div class="schedule-toggle">
                            <label>
                                <input type="radio" name="schedule" value="now" checked onclick="toggleSchedule()">
                                <i class="fas fa-bolt"></i> Post Now
                            </label>
                            <label>
                                <input type="radio" name="schedule" value="later" onclick="toggleSchedule()">
                                <i class="fas fa-calendar"></i> Schedule for Later
                            </label>
                        </div>

                        <div class="schedule-datetime" id="schedule-datetime">
                            <div class="form-group">
                                <label for="schedule-date">Date & Time</label>
                                <input type="datetime-local" id="schedule-date" required>
                            </div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="createPost()">
                            <i class="fas fa-magic"></i> Generate & Post
                        </button>
                        <button class="btn btn-secondary" onclick="previewPost()">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                    </div>
                </form>
            </div>

            <!-- Posts Tab -->
            <div id="posts" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #495057;"><i class="fas fa-list"></i> My Posts</h2>

                <div id="posts-message" class="hidden"></div>

                <button class="btn btn-primary" onclick="loadPosts()" style="margin-bottom: 20px;">
                    <i class="fas fa-sync"></i> Refresh Posts
                </button>

                <div id="posts-list" class="posts-list">
                    <p style="color: #6c757d; text-align: center;">Loading posts...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Platform Setup Modal (simplified inline) -->
    <div id="platform-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
            <h3 id="modal-title">Setup Platform</h3>
            <div id="modal-content">
                <!-- Instagram Form -->
                <div id="instagram-form" class="hidden">
                    <div class="form-group">
                        <label>Instagram Username</label>
                        <input type="text" id="instagram-username" placeholder="your_username">
                    </div>
                    <div class="form-group">
                        <label>Instagram Password</label>
                        <input type="password" id="instagram-password" placeholder="your_password">
                    </div>
                </div>

                <div id="facebook-form" class="hidden">
                    <div class="form-group">
                        <label>Facebook Page Access Token</label>
                        <input type="text" id="facebook-token" placeholder="EAAB...">
                    </div>
                    <div class="form-group">
                        <label>Facebook Page ID</label>
                        <input type="text" id="facebook-page-id" placeholder="123456789">
                    </div>
                </div>

                <div id="youtube-form" class="hidden">
                    <div class="form-group">
                        <label>Client Secrets File Path</label>
                        <input type="text" id="youtube-client-secrets" placeholder="config/client_secrets.json" value="config/client_secrets.json">
                    </div>
                    <div class="form-group">
                        <label>Credentials File Path (Optional)</label>
                        <input type="text" id="youtube-credentials" placeholder="config/youtube_credentials.json" value="">
                    </div>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-top: 10px;">
                        Download client_secrets.json from Google Cloud Console and place it in the config folder.
                        The credentials.json will be generated during OAuth setup.
                    </p>
                </div>

                <div id="linkedin-form" class="hidden">
                    <div class="form-group">
                        <label>LinkedIn Access Token</label>
                        <input type="text" id="linkedin-token" placeholder="AQX...">
                    </div>
                    <div class="form-group">
                        <label>LinkedIn Person URN</label>
                        <input type="text" id="linkedin-person-urn" placeholder="urn:li:person:xxxxx">
                    </div>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="savePlatformCredentials()">Save & Test</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let availablePlatforms = [];
        let currentPlatformSetup = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Set default schedule date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0);
            document.getElementById('schedule-date').value = tomorrow.toISOString().slice(0, 16);

            // Load platforms
            loadSupportedPlatforms();
        });

        function showTab(tabName, clickedElement = null) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');

            // Find and activate the corresponding button
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else {
                // Find button by tab name
                const button = document.querySelector(`button[onclick*="${tabName}"]`);
                if (button) button.classList.add('active');
            }
        }

        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `alert alert-${type}`;
            element.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            element.classList.remove('hidden');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        function showLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        }

        async function register() {
            const email = document.getElementById('register-email').value;
            const name = document.getElementById('register-name').value;
            const password = document.getElementById('register-password').value;

            if (!email || !name || !password) {
                showMessage('auth-message', 'Please fill all fields', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        full_name: name,
                        password: password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('auth-message', 'Account created successfully! Please login.', 'success');
                    showLogin();
                } else {
                    showMessage('auth-message', data.detail || 'Registration failed', 'error');
                }
            } catch (error) {
                showMessage('auth-message', 'Network error. Please try again.', 'error');
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showMessage('auth-message', 'Please enter email and password', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `username=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`
                });

                const data = await response.json();

                if (response.ok) {
                    currentUser = data.user;
                    localStorage.setItem('token', data.access_token);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    console.log('Login successful, token stored:', data.access_token.substring(0, 20) + '...');
                    showMessage('auth-message', `Welcome back, ${data.user.full_name}!`, 'success');

                    // Enable tabs and switch to platforms
                    document.getElementById('platforms-tab').disabled = false;
                    document.getElementById('create-tab').disabled = false;
                    document.getElementById('posts-tab').disabled = false;

                    setTimeout(() => {
                        showTab('platforms');
                        checkPlatformStatus();
                    }, 1500);

                } else {
                    showMessage('auth-message', data.detail || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage('auth-message', 'Network error. Please try again.', 'error');
            }
        }

        async function loadSupportedPlatforms() {
            try {
                const response = await fetch('/api/platforms/supported');
                const data = await response.json();

                availablePlatforms = data.platforms;

                // Populate platform checkboxes
                const checkboxes = document.getElementById('platform-checkboxes');
                checkboxes.innerHTML = '';

                data.platforms.forEach(platform => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" value="${platform.name}" class="platform-checkbox">
                            <i class="fab fa-${platform.name}"></i> ${platform.display_name}
                        </label>
                    `;
                    checkboxes.appendChild(div);
                });

            } catch (error) {
                console.error('Failed to load platforms:', error);
            }
        }

        async function checkPlatformStatus() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch('/api/platforms/onboarding-status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Update platform cards
                    data.platforms.forEach(platform => {
                        const card = document.getElementById(`${platform.platform}-card`);
                        const status = document.getElementById(`${platform.platform}-status`);

                        if (platform.connected) {
                            card.classList.add('connected');
                            status.textContent = 'Connected';
                            status.className = 'status-badge status-connected';
                        } else {
                            card.classList.remove('connected');
                            status.textContent = platform.error_message || 'Not Connected';
                            status.className = 'status-badge status-disconnected';
                        }
                    });

                    showMessage('platforms-message', 'Platform status updated!', 'success');
                }
            } catch (error) {
                showMessage('platforms-message', 'Failed to check platform status', 'error');
            }
        }

        async function testToken() {
            const token = localStorage.getItem('token');
            console.log('Testing token:', token ? 'present' : 'missing');

            if (!token) {
                showMessage('platforms-message', 'No token found. Please login first.', 'error');
                return;
            }

            try {
                console.log('Making authenticated request to /api/me');
                const response = await fetch('/api/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Test response status:', response.status);

                if (response.ok) {
                    const userData = await response.json();
                    console.log('Token test successful:', userData);
                    showMessage('platforms-message', `âœ… Token valid! Logged in as ${userData.full_name}`, 'success');
                } else {
                    const errorData = await response.text();
                    console.log('Token test failed:', errorData);
                    showMessage('platforms-message', `âŒ Token invalid: ${errorData}`, 'error');
                }
            } catch (error) {
                console.error('Token test error:', error);
                showMessage('platforms-message', `âŒ Network error: ${error.message}`, 'error');
            }
        }

        async function debugToken() {
            const token = localStorage.getItem('token');
            console.log('Debugging token:', token ? token.substring(0, 50) + '...' : 'missing');

            if (!token) {
                showMessage('platforms-message', 'No token found to debug.', 'error');
                return;
            }

            try {
                console.log('Making debug request to /api/debug-token');
                const response = await fetch('/api/debug-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({})  // Empty body, token in header
                });

                const debugData = await response.json();
                console.log('Debug response:', debugData);

                if (response.ok) {
                    showMessage('platforms-message', `ðŸ” Debug: ${JSON.stringify(debugData, null, 2)}`, 'info');
                } else {
                    showMessage('platforms-message', `âŒ Debug failed: ${JSON.stringify(debugData)}`, 'error');
                }
            } catch (error) {
                console.error('Debug error:', error);
                showMessage('platforms-message', `âŒ Debug network error: ${error.message}`, 'error');
            }
        }

        function setupPlatform(platform) {
            currentPlatformSetup = platform;

            // Hide all forms
            document.querySelectorAll('#modal-content > div').forEach(div => {
                div.classList.add('hidden');
            });

            // Show platform-specific form
            document.getElementById(`${platform}-form`).classList.remove('hidden');
            document.getElementById('modal-title').textContent = `Setup ${platform.charAt(0).toUpperCase() + platform.slice(1)}`;

            // Show modal
            document.getElementById('platform-modal').classList.remove('hidden');
        }

        async function disconnectPlatform(platform, event) {
            event.stopPropagation(); // Prevent card click

            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please login first');
                return;
            }

            if (!confirm(`Are you sure you want to disconnect ${platform}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/platforms/connection/${platform}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showMessage('platforms-message', `${platform} disconnected successfully!`, 'success');
                    checkPlatformStatus();
                } else {
                    const error = await response.json();
                    showMessage('platforms-message', error.detail || 'Failed to disconnect', 'error');
                }
            } catch (error) {
                showMessage('platforms-message', 'Network error. Please try again.', 'error');
            }
        }

        function closeModal() {
            document.getElementById('platform-modal').classList.add('hidden');
            currentPlatformSetup = null;
        }

        async function savePlatformCredentials() {
            if (!currentPlatformSetup) return;

            const token = localStorage.getItem('token');
            console.log('Token retrieved:', token ? 'present' : 'missing');
            if (!token) {
                alert('Please login first');
                return;
            }

            let credentials = {};

            // Collect platform-specific credentials
            if (currentPlatformSetup === 'instagram') {
                credentials = {
                    username: document.getElementById('instagram-username').value,
                    password: document.getElementById('instagram-password').value
                };
            } else if (currentPlatformSetup === 'facebook') {
                credentials = {
                    access_token: document.getElementById('facebook-token').value,
                    page_id: document.getElementById('facebook-page-id').value
                };
            } else if (currentPlatformSetup === 'youtube') {
                credentials = {
                    client_secrets_file: document.getElementById('youtube-client-secrets').value,
                    credentials_file: document.getElementById('youtube-credentials').value
                };
            } else if (currentPlatformSetup === 'linkedin') {
                credentials = {
                    access_token: document.getElementById('linkedin-token').value,
                    person_urn: document.getElementById('linkedin-person-urn').value
                };
            }

            if (!Object.values(credentials).every(val => val.trim())) {
                alert('Please fill all required fields');
                return;
            }

            console.log('Sending request with token:', token.substring(0, 20) + '...');
            console.log('Request headers:', {
                'Authorization': `Bearer ${token.substring(0, 20)}...`,
                'Content-Type': 'application/json'
            });

            try {
                const response = await fetch(`/api/platforms/setup/${currentPlatformSetup}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(credentials)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                const data = await response.json();

                if (response.ok) {
                    showMessage('platforms-message', `${currentPlatformSetup} connected successfully!`, 'success');
                    closeModal();
                    checkPlatformStatus();
                } else {
                    showMessage('platforms-message', data.detail || 'Failed to connect platform', 'error');
                }
            } catch (error) {
                showMessage('platforms-message', 'Network error. Please try again.', 'error');
            }
        }

        function toggleSchedule() {
            const scheduleType = document.querySelector('input[name="schedule"]:checked').value;
            const datetimeDiv = document.getElementById('schedule-datetime');

            if (scheduleType === 'later') {
                datetimeDiv.classList.add('active');
            } else {
                datetimeDiv.classList.remove('active');
            }
        }

        async function createPost() {
            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('create-message', 'Please login first', 'error');
                return;
            }

            const contentType = document.getElementById('content-type').value;
            const prompt = document.getElementById('prompt').value;
            const caption = document.getElementById('caption').value;

            // Get selected platforms
            const selectedPlatforms = Array.from(document.querySelectorAll('.platform-checkbox:checked'))
                .map(cb => cb.value);

            if (!prompt.trim()) {
                showMessage('create-message', 'Please enter a prompt', 'error');
                return;
            }

            if (selectedPlatforms.length === 0) {
                showMessage('create-message', 'Please select at least one platform', 'error');
                return;
            }

            // Get scheduling info
            const scheduleType = document.querySelector('input[name="schedule"]:checked').value;
            let scheduledAt = 'now';

            if (scheduleType === 'later') {
                const dateTime = document.getElementById('schedule-date').value;
                if (!dateTime) {
                    showMessage('create-message', 'Please select a date and time', 'error');
                    return;
                }
                scheduledAt = new Date(dateTime).toISOString();
            }

            // Show loading
            const submitBtn = document.querySelector('#create button[onclick="createPost()"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading"></div> Generating AI content...';
            submitBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('content_type', contentType);
                formData.append('platforms', JSON.stringify(selectedPlatforms));
                formData.append('scheduled_at', scheduledAt);
                if (caption.trim()) {
                    formData.append('caption', caption);
                }

                const response = await fetch('/api/posts/generate-and-post', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok && !data.error) {
                    showMessage('create-message',
                        `Post ${data.posted_now ? 'created and posted' : 'scheduled'} successfully!`,
                        'success'
                    );

                    // Clear form
                    document.getElementById('prompt').value = '';
                    document.getElementById('caption').value = '';

                    // Refresh posts if we're posting now
                    if (data.posted_now) {
                        setTimeout(() => loadPosts(), 1000);
                    }
                } else {
                    // Handle different types of responses
                    if (data.error === "AI content generation not available") {
                        // Special case: AI generation not available but request was valid
                        showMessage('create-message',
                            `${data.message}\n\nðŸ’¡ Example CLI command:\n${data.cli_command}`,
                            'info'
                        );
                    } else {
                        // Show detailed error message for better user experience
                        let errorMsg = data.detail || data.error || 'Failed to create post';
                        if (errorMsg.includes('Google Drive credentials')) {
                            errorMsg += '\n\nðŸ’¡ Tip: Use the CLI tools (generatepost.py) to create AI content, then upload the generated files manually.';
                        }
                        showMessage('create-message', errorMsg, 'error');
                    }
                }
            } catch (error) {
                showMessage('create-message', 'Network error. Please try again.', 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        function previewPost() {
            const prompt = document.getElementById('prompt').value;
            const caption = document.getElementById('caption').value;
            const contentType = document.getElementById('content-type').value;

            if (!prompt.trim()) {
                showMessage('create-message', 'Please enter a prompt to preview', 'error');
                return;
            }

            const selectedPlatforms = Array.from(document.querySelectorAll('.platform-checkbox:checked'))
                .map(cb => cb.value);

            let preview = `<h4>Post Preview</h4>
                          <p><strong>Type:</strong> ${contentType}</p>
                          <p><strong>Prompt:</strong> ${prompt}</p>
                          <p><strong>Caption:</strong> ${caption || 'AI-generated content: ' + prompt.substring(0, 50) + '...'}</p>
                          <p><strong>Platforms:</strong> ${selectedPlatforms.join(', ') || 'None selected'}</p>`;

            showMessage('create-message', preview, 'info');
        }

        async function loadPosts() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch('/api/posts', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const posts = await response.json();

                const postsList = document.getElementById('posts-list');

                if (posts.length === 0) {
                    postsList.innerHTML = '<p style="text-align: center; color: #6c757d;">No posts yet. Create your first post!</p>';
                    return;
                }

                postsList.innerHTML = '';

                posts.forEach(post => {
                    const postDiv = document.createElement('div');
                    postDiv.className = 'post-item';

                    const statusColor = {
                        'draft': '#6c757d',
                        'scheduled': '#ffc107',
                        'posted': '#28a745',
                        'failed': '#dc3545',
                        'partially_posted': '#fd7e14'
                    }[post.status] || '#6c757d';

                    postDiv.innerHTML = `
                        <h4>${post.title || 'Untitled Post'}</h4>
                        <p>${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</p>
                        <div class="post-meta">
                            <span style="color: ${statusColor}; font-weight: bold;">${post.status.toUpperCase()}</span>
                            | Type: ${post.content_type}
                            | Created: ${new Date(post.created_at).toLocaleString()}
                            ${post.scheduled_at ? `| Scheduled: ${new Date(post.scheduled_at).toLocaleString()}` : ''}
                        </div>
                    `;

                    postsList.appendChild(postDiv);
                });

            } catch (error) {
                document.getElementById('posts-list').innerHTML =
                    '<p style="text-align: center; color: #dc3545;">Failed to load posts</p>';
            }
        }

        // Auto-load user session on page load
        const savedToken = localStorage.getItem('token');
        const savedUser = localStorage.getItem('user');

        if (savedToken && savedUser) {
            currentUser = JSON.parse(savedUser);
            document.getElementById('platforms-tab').disabled = false;
            document.getElementById('create-tab').disabled = false;
            document.getElementById('posts-tab').disabled = false;

            showMessage('auth-message', `Welcome back, ${currentUser.full_name}!`, 'success');
            setTimeout(() => {
                showTab('platforms');
                checkPlatformStatus();
            }, 1000);
        }
    </script>
</body>
</html>